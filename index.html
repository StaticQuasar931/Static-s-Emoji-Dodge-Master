<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Dodge Master</title>
    <style>
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #1e3c72, #1a508b);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            position: relative;
            transition: background 0.5s;
        }

        /* Light/Dark Themes */
        body.light {
            background: linear-gradient(to bottom, #ffffff, #cccccc);
            color: #333;
        }

        /* Top Left Footer - "Made by Static" */
        .footer {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            z-index: 20;
            pointer-events: none;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5); /* Slight background for contrast */
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* Rainbow Animation for Each Letter */
        .rainbow-letter {
            animation: rainbow 2s infinite;
            display: inline-block;
            margin: 0 1px;
        }

        @keyframes rainbow {
            0% { color: red; }
            14% { color: orange; }
            28% { color: yellow; }
            42% { color: green; }
            56% { color: blue; }
            70% { color: indigo; }
            84% { color: violet; }
            100% { color: red; }
        }

        /* Layout Container */
        .game-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            height: 100%;
            padding-top: 60px; /* Space for footer */
            box-sizing: border-box;
        }

        /* Shield Info Panel */
        .shield-info {
            position: absolute;
            left: 10px;
            bottom: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 5px;
            z-index: 15;
            font-size: 14px;
            width: 200px;
            text-align: left;
        }

        /* Canvas Styling */
        canvas {
            border: 2px solid #444;
            background: rgba(0, 0, 0, 0.1);
            width: 90vw;
            max-width: 600px;
            height: 150vw;
            max-height: 900px;
            transition: width 0.5s, height 0.5s;
        }

        /* UI Panel */
        .ui {
            display: flex;
            justify-content: space-between;
            width: 90vw;
            max-width: 600px;
            margin: 10px 0;
            z-index: 10;
        }
        .highScore, .money, .score, .upgrades {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            font-size: 18px;
        }
        .upgrades {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .upgrade-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .upgrade-item span {
            font-size: 14px;
        }
        .upgrade-item button {
            padding: 3px 6px;
            font-size: 14px;
            background: #666;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .upgrade-item button:hover:not(:disabled) {
            background: #777;
        }
        .upgrade-item button:disabled {
            background: #333;
            cursor: not-allowed;
        }

        /* Shop Interface */
        .shop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 30;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: opacity 0.5s;
        }
        .shop.active {
            display: flex;
        }
        .shop h1 {
            margin-bottom: 20px;
        }
        .shop-item {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shop-item span {
            flex: 1;
            font-size: 16px;
        }
        .shop-item button {
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            border-radius: 3px;
            background-color: #666;
            color: white;
        }
        .shop-item button:hover:not(:disabled) {
            background-color: #777;
        }
        .shop-item button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }
        .shop button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .shop button:hover {
            background: #555;
        }

        /* Menu Interface */
        .menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 30;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: opacity 0.5s;
        }
        .menu.active {
            display: flex;
        }
        .menu h1 {
            margin-bottom: 20px;
            font-size: 32px;
        }
        .menu p {
            margin: 10px 0;
            font-size: 16px;
            text-align: center;
        }
        .menu button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 18px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .menu button:hover {
            background: #555;
        }
        .menu p#deathMessage {
            margin-top: 20px;
            font-size: 20px;
            color: #ff4444;
        }

        /* QR Code Styling */
        .qr-code {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            cursor: pointer;
            z-index: 10;
        }

        /* Footer Link Styling */
        .footer a {
            color: #00bfff;
            text-decoration: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { text-shadow: 0 0 5px #fff; }
            50% { text-shadow: 0 0 20px #ff00ff; }
            100% { text-shadow: 0 0 5px #fff; }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .ui {
                flex-direction: column;
                align-items: center;
            }
            .highScore, .money, .score, .upgrades {
                margin: 5px 0;
                width: 100%;
            }
            canvas {
                margin-top: 100px; /* Increased space for larger footer */
            }
            .shop-item span {
                font-size: 14px;
            }
            .shop-item button {
                font-size: 14px;
            }
            .menu p {
                font-size: 14px;
            }
            .menu button {
                font-size: 16px;
            }
            .shield-info {
                width: 150px;
                font-size: 12px;
                padding: 8px;
            }
        }

        /* Upgrade Button Styles */
        .upgrade-available {
            background-color: #28a745; /* Green */
            color: white;
        }
        .upgrade-unavailable {
            background-color: #333; /* Dark Gray */
            color: #777;
            cursor: not-allowed;
        }

        /* Pause Button */
        .pause-button {
            position: absolute;
            top: 10px;
            left: 220px; /* Adjusted based on shield info panel */
            z-index: 25;
            padding: 10px 20px;
            font-size: 16px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .pause-button:hover {
            background: #555;
        }

        /* Top Right Buttons (Help and Settings) */
        .top-right-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 25;
            display: flex;
            gap: 10px;
        }
        .top-right-buttons button {
            padding: 8px 16px;
            font-size: 14px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .top-right-buttons button:hover {
            background: #555;
        }

        /* Tooltip Styling */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 160px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 40;
            bottom: 125%; /* Position above the element */
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Feedback Link */
        .feedback-link {
            margin-top: 20px;
            font-size: 14px;
            color: #00bfff;
            text-decoration: none;
            transition: color 0.3s;
        }
        .feedback-link:hover {
            color: #ff00ff;
        }

        /* Light/Dark Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 10px;
            left: 280px; /* Adjusted based on shield info and pause button */
            z-index: 25;
            padding: 8px 16px;
            font-size: 14px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .theme-toggle:hover {
            background: #555;
        }

        /* Shield Info Panel Styling */
        .shield-info {
            position: absolute;
            left: 10px;
            bottom: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 5px;
            z-index: 15;
            font-size: 14px;
            width: 200px;
            text-align: left;
        }

        /* On-Screen Buttons for Mobile Controls */
        .mobile-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 25;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mobile-controls button {
            width: 50px;
            height: 50px;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        .mobile-controls button:hover {
            background: rgba(0, 0, 0, 0.8);
        }
    </style>
    <!-- Import Zombie-like Font -->
    <link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Top Left Footer - "Made by Static" -->
    <div class="footer">
        <!-- Each letter wrapped in a span for individual animation -->
        <a href="https://sites.google.com/view/staticquasar931" target="_blank" aria-label="Visit Static Quasar's Website">
            <span class="rainbow-letter">M</span>
            <span class="rainbow-letter">a</span>
            <span class="rainbow-letter">d</span>
            <span class="rainbow-letter">e</span>
            <span class="rainbow-letter"> </span>
            <span class="rainbow-letter">b</span>
            <span class="rainbow-letter">y</span>
            <span class="rainbow-letter"> </span>
            <span class="rainbow-letter">S</span>
            <span class="rainbow-letter">t</span>
            <span class="rainbow-letter">a</span>
            <span class="rainbow-letter">t</span>
            <span class="rainbow-letter">i</span>
            <span class="rainbow-letter">c</span>
        </a>
    </div>

    <!-- Game Container -->
    <div class="game-container">
        <!-- Shield Info Panel -->
        <div class="shield-info" id="shieldInfo">
            Shield Status:<br>
            <span id="shieldStatus">Ready</span><br>
            <span id="shieldTimer"></span>
        </div>

        <!-- Canvas and UI -->
        <div style="position: relative;">
            <!-- UI Panel -->
            <div class="ui">
                <div class="highScore">
                    High Score: <span id="highScore">0</span>
                </div>
                <div class="money">
                    Money: $<span id="money">0</span>
                </div>
                <div class="score">
                    Score: <span id="score">0</span>
                </div>
                <div class="upgrades">
                    <div class="upgrade-item tooltip">
                        <span>Speed Upgrade: <span id="speedLevel">0</span></span>
                        <button id="upgradeSpeedMain" class="upgrade-unavailable" aria-label="Buy Speed Upgrade">Buy</button>
                        <span class="tooltiptext">Gradually increases your movement speed.</span>
                    </div>
                    <div class="upgrade-item tooltip">
                        <span>Double Money: <span id="doubleMoneyLevel">0</span></span>
                        <button id="buyDoubleMoneyMain" class="upgrade-unavailable" aria-label="Buy Double Money Upgrade">Buy</button>
                        <span class="tooltiptext">Earn double money from collectibles.</span>
                    </div>
                    <div class="upgrade-item tooltip">
                        <span>Shield: <span id="shieldLevel">0</span></span>
                        <button id="buyShieldMain" class="upgrade-unavailable" aria-label="Buy Shield Upgrade">Buy</button>
                        <span class="tooltiptext">Activates a protective shield.</span>
                    </div>
                    <div class="upgrade-item tooltip">
                        <span>Acceleration Boost: <span id="accelerationLevel">0</span></span>
                        <button id="buyAccelerationMain" class="upgrade-unavailable" aria-label="Buy Acceleration Boost">Buy</button>
                        <span class="tooltiptext">Enhances your speed acceleration.</span>
                    </div>
                    <div class="upgrade-item tooltip">
                        <span>Max Speed Increase: <span id="maxSpeedLevel">0</span></span>
                        <button id="buyMaxSpeedMain" class="upgrade-unavailable" aria-label="Buy Max Speed Increase">Buy</button>
                        <span class="tooltiptext">Increases your maximum movement speed.</span>
                    </div>
                </div>
            </div>

            <!-- Game Canvas -->
            <canvas id="gameCanvas" width="600" height="900"></canvas>

            <!-- Shield Info Display (Left of Gameplay Area) -->
            <div class="shield-info" id="shieldInfo">
                Shield Status:<br>
                <span id="shieldStatus">Ready</span><br>
                <span id="shieldTimer"></span>
            </div>

            <!-- Pause Button -->
            <button class="pause-button" id="pauseButton" aria-label="Pause Game">Pause</button>

            <!-- Top Right Buttons (Help and Settings) -->
            <div class="top-right-buttons">
                <button id="helpButton" aria-label="Open Help">Help</button>
                <button id="settingsButton" aria-label="Open Settings">Settings</button>
            </div>
        </div>
    </div>

    <!-- Shop Interface -->
    <div class="shop" id="shop">
        <h1>Shop</h1>
        <div class="shop-item tooltip">
            <span>Speed Upgrade ($50)</span>
            <button id="upgradeSpeed" class="upgrade-unavailable" aria-label="Buy Speed Upgrade">Buy ($50)</button>
            <span class="tooltiptext">Gradually increases your movement speed.</span>
        </div>
        <div class="shop-item tooltip">
            <span>Shield Upgrade ($100)</span>
            <button id="buyShield" class="upgrade-unavailable" aria-label="Buy Shield Upgrade">Buy ($100)</button>
            <span class="tooltiptext">Activates a protective shield.</span>
        </div>
        <div class="shop-item tooltip">
            <span>Double Money Upgrade ($150)</span>
            <button id="buyDoubleMoney" class="upgrade-unavailable" aria-label="Buy Double Money Upgrade">Buy ($150)</button>
            <span class="tooltiptext">Earn double money from collectibles.</span>
        </div>
        <div class="shop-item tooltip">
            <span>Acceleration Boost ($200)</span>
            <button id="buyAcceleration" class="upgrade-unavailable" aria-label="Buy Acceleration Boost">Buy ($200)</button>
            <span class="tooltiptext">Enhances your speed acceleration.</span>
        </div>
        <div class="shop-item tooltip">
            <span>Max Speed Increase ($250)</span>
            <button id="buyMaxSpeed" class="upgrade-unavailable" aria-label="Buy Max Speed Increase">Buy ($250)</button>
            <span class="tooltiptext">Increases your maximum movement speed.</span>
        </div>
        <button id="closeShop">Close Shop</button>
    </div>

    <!-- Menu Interface -->
    <div class="menu" id="menu">
        <h1>Emoji Dodge Master</h1>
        <p>Use Left/Right Arrow Keys or A/D to move horizontally.</p>
        <p>Press W to dash left and S to dash right.</p>
        <p>Avoid 🔥 and 💣, and collect ⭐ and 💰 to earn points!</p>
        <button id="startButton">Start Game</button>
        <button id="openShop">Shop</button>
        <p id="deathMessage" style="display:none">Game Over! Try Again!</p>
    </div>

    <!-- QR Code Link -->
    <a href="https://sites.google.com/view/staticquasar931" target="_blank">
        <img src="https://res.cloudinary.com/dcsrqennd/image/upload/v1733694622/frame_1_vmv9y3.png" alt="Scan QR Code to visit Static Quasar's website" class="qr-code">
    </a>

    <!-- Settings Interface -->
    <div class="shop" id="settingsMenu">
        <h1>Settings</h1>
        <div class="upgrade-item">
            <span>Background Music Volume:</span>
            <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.3">
        </div>
        <div class="upgrade-item">
            <span>Sound Effects Volume:</span>
            <input type="range" id="sfxVolume" min="0" max="1" step="0.01" value="0.5">
        </div>
        <div class="upgrade-item">
            <span>Frame Rate:</span>
            <select id="frameRate">
                <option value="60">60 FPS</option>
                <option value="80" selected>80 FPS</option>
                <option value="30">30 FPS</option>
            </select>
        </div>
        <div class="upgrade-item">
            <span>Theme:</span>
            <select id="themeSelect">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
            </select>
        </div>
        <div class="upgrade-item">
            <span>Save Game:</span>
            <button id="saveGame">Save Now</button>
        </div>
        <div class="upgrade-item">
            <span>Reset Data:</span>
            <button id="resetData">Reset Data</button>
        </div>
        <div class="upgrade-item">
            <span>Feedback:</span>
            <a href="https://forms.gle/9x1eGuBw4UeYGbk26" target="_blank" class="feedback-link">Provide Feedback</a>
        </div>
        <button id="closeSettings">Close Settings</button>
    </div>

    <!-- Help Interface -->
    <div class="shop" id="helpMenu">
        <h1>Help</h1>
        <p>Controls:</p>
        <ul>
            <li>Move Left: Left Arrow Key or A</li>
            <li>Move Right: Right Arrow Key or D</li>
            <li>Dash Left: W</li>
            <li>Dash Right: S</li>
            <li>Activate Shield: Spacebar</li>
            <li>Pause Game: Click Pause Button or Press Escape</li>
        </ul>
        <button id="closeHelp">Close Help</button>
    </div>

    <!-- On-Screen Mobile Controls -->
    <div class="mobile-controls" id="mobileControls">
        <button id="dashLeft" aria-label="Dash Left">W</button>
        <button id="dashRight" aria-label="Dash Right">S</button>
    </div>

    <!-- Audio Elements -->
    <audio id="bgMusic" loop>
        <source src="data:audio/mp3;base64,//uQx... (base64 data)" type="audio/mp3">
        <!-- Replace with actual base64 audio data -->
    </audio>
    <audio id="collectSound">
        <source src="data:audio/mp3;base64,//uQx... (base64 data)" type="audio/mp3">
        <!-- Replace with actual base64 audio data -->
    </audio>
    <audio id="collisionSound">
        <source src="data:audio/mp3;base64,//uQx... (base64 data)" type="audio/mp3">
        <!-- Replace with actual base64 audio data -->
    </audio>
    <audio id="shieldSound">
        <source src="data:audio/mp3;base64,//uQx... (base64 data)" type="audio/mp3">
        <!-- Replace with actual base64 audio data -->
    </audio>
    <audio id="bombExplosionSound">
        <source src="data:audio/mp3;base64,//uQx... (base64 data)" type="audio/mp3">
        <!-- Replace with actual base64 audio data -->
    </audio>

    <script>
        // DOM Elements
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const scoreDisplay = document.getElementById("score");
        const highScoreDisplay = document.getElementById("highScore");
        const moneyDisplay = document.getElementById("money");
        const menu = document.getElementById("menu");
        const shop = document.getElementById("shop");
        const startButton = document.getElementById("startButton");
        const openShopButton = document.getElementById("openShop");
        const closeShopButton = document.getElementById("closeShop");
        const deathMessage = document.getElementById("deathMessage");
        const upgradeSpeedButton = document.getElementById("upgradeSpeed");
        const buyShieldButton = document.getElementById("buyShield");
        const buyDoubleMoneyButton = document.getElementById("buyDoubleMoney");
        const buyAccelerationButton = document.getElementById("buyAcceleration");
        const buyMaxSpeedButton = document.getElementById("buyMaxSpeed");
        const upgradeSpeedMain = document.getElementById("upgradeSpeedMain");
        const buyShieldMain = document.getElementById("buyShieldMain");
        const buyDoubleMoneyMain = document.getElementById("buyDoubleMoneyMain");
        const buyAccelerationMain = document.getElementById("buyAccelerationMain");
        const buyMaxSpeedMain = document.getElementById("buyMaxSpeedMain");
        const speedLevelDisplay = document.getElementById("speedLevel");
        const doubleMoneyLevelDisplay = document.getElementById("doubleMoneyLevel");
        const shieldLevelDisplay = document.getElementById("shieldLevel");
        const accelerationLevelDisplay = document.getElementById("accelerationLevel");
        const maxSpeedLevelDisplay = document.getElementById("maxSpeedLevel");
        const pauseButton = document.getElementById("pauseButton");
        const helpButton = document.getElementById("helpButton");
        const settingsButton = document.getElementById("settingsButton");
        const helpMenu = document.getElementById("helpMenu");
        const closeHelpButton = document.getElementById("closeHelp");
        const settingsMenu = document.getElementById("settingsMenu");
        const closeSettingsButton = document.getElementById("closeSettings");
        const themeToggle = document.getElementById("themeSelect");
        const frameRateSelect = document.getElementById("frameRate");
        const musicVolume = document.getElementById("musicVolume");
        const sfxVolume = document.getElementById("sfxVolume");
        const saveGameButton = document.getElementById("saveGame");
        const resetDataButton = document.getElementById("resetData");
        const shieldInfo = document.getElementById("shieldInfo");
        const shieldStatus = document.getElementById("shieldStatus");
        const shieldTimer = document.getElementById("shieldTimer");
        const mobileControls = document.getElementById("mobileControls");
        const dashLeftButton = document.getElementById("dashLeft");
        const dashRightButton = document.getElementById("dashRight");

        // Audio Elements
        const bgMusic = document.getElementById("bgMusic");
        const collectSound = document.getElementById("collectSound");
        const collisionSound = document.getElementById("collisionSound");
        const shieldSound = document.getElementById("shieldSound");
        const bombExplosionSound = document.getElementById("bombExplosionSound");

        // Game State Variables
        let highScore = localStorage.getItem('highScore') ? parseInt(localStorage.getItem('highScore')) : 0;
        highScoreDisplay.textContent = highScore;

        let money = localStorage.getItem('money') ? parseInt(localStorage.getItem('money')) : 0;
        moneyDisplay.textContent = money;

        let score = localStorage.getItem('score') ? parseInt(localStorage.getItem('score')) : 0;
        scoreDisplay.textContent = score;

        let speedUpgrade = localStorage.getItem('speedUpgrade') ? parseInt(localStorage.getItem('speedUpgrade')) : 0;
        let doubleMoneyUpgrade = localStorage.getItem('doubleMoneyUpgrade') ? parseInt(localStorage.getItem('doubleMoneyUpgrade')) : 0;
        let shieldUpgrade = localStorage.getItem('shieldUpgrade') ? parseInt(localStorage.getItem('shieldUpgrade')) : 0;
        let accelerationUpgrade = localStorage.getItem('accelerationUpgrade') ? parseInt(localStorage.getItem('accelerationUpgrade')) : 0;
        let maxSpeedUpgrade = localStorage.getItem('maxSpeedUpgrade') ? parseInt(localStorage.getItem('maxSpeedUpgrade')) : 0;

        speedLevelDisplay.textContent = speedUpgrade;
        doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
        shieldLevelDisplay.textContent = shieldUpgrade;
        accelerationLevelDisplay.textContent = accelerationUpgrade;
        maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;

        const player = {
            x: canvas.width / 2 - 20,
            y: canvas.height - 80, // Positioned near the bottom for sliding under shield
            width: 40,
            height: 40,
            emoji: "😎",
            baseSpeed: 5,
            speed: 5,
            acceleration: 0.1 + (accelerationUpgrade * 0.05),
            currentAcceleration: 0,
            maxSpeed: 15 + (maxSpeedUpgrade * 1),
            dashSpeed: 15,
            dashCooldown: 0,
            dashDuration: 15, // Frames
            canDash: true,
            shield: false,
            shieldCooldown: 0,
            shieldDuration: 0
        };

        // Stationary Shield Position (bottom left corner)
        const shieldObj = {
            x: 20,
            y: canvas.height - 120,
            width: 150,
            height: 60,
            active: false,
            cooldown: 0,
            duration: 0,
            canActivate: true
        };

        let obstacles = [];
        let stars = [];
        let gameOver = false;
        let gamePaused = false;
        let keys = {};

        let spawnInterval;
        let animationFrameId;
        let targetFPS = 80;
        let frameDuration = 1000 / targetFPS;
        let lastFrameTime = performance.now();

        // Function to Save Progress
        function saveProgress() {
            localStorage.setItem('highScore', highScore);
            localStorage.setItem('money', money);
            localStorage.setItem('score', score);
            localStorage.setItem('speedUpgrade', speedUpgrade);
            localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
            localStorage.setItem('shieldUpgrade', shieldUpgrade);
            localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
            localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
            localStorage.setItem('lastSaveTime', Date.now());
        }

        // Reset Game State
        function resetGame() {
            player.x = canvas.width / 2 - 20;
            player.y = canvas.height - 80;
            player.speed = player.baseSpeed;
            player.currentAcceleration = 0;
            player.canDash = true;
            player.shield = false;
            player.shieldCooldown = 0;
            player.shieldDuration = 0;

            shieldObj.active = false;
            shieldObj.cooldown = 0;
            shieldObj.duration = 0;
            shieldObj.canActivate = true;

            obstacles = [];
            stars = [];
            score = 0;
            gameOver = false;
            scoreDisplay.textContent = score;
            deathMessage.style.display = "none";
            updateBuyButtons();
            saveProgress();
        }

        // Create Obstacles
        function createObstacle() {
            const x = Math.random() * (canvas.width - 40);
            const y = -40;
            const speed = 3 + speedUpgrade;
            const types = ['fire', 'bomb'];
            const type = types[Math.floor(Math.random() * types.length)];
            const emoji = type === 'fire' ? '🔥' : '💣';
            obstacles.push({ x, y, width: 40, height: 40, emoji, speed, type });
        }

        // Create Stars
        function createStar() {
            const x = Math.random() * (canvas.width - 40);
            const y = -40;
            const speed = 3 + speedUpgrade; // Same speed as obstacles for consistency
            const types = ['star', 'money'];
            const type = types[Math.floor(Math.random() * types.length)];
            const emoji = type === 'star' ? '⭐' : '💰';
            stars.push({ x, y, width: 40, height: 40, emoji, speed, type });
        }

        // Draw Player
        function drawPlayer() {
            ctx.font = "40px Arial"; // Increased font size
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(player.emoji, player.x + player.width / 2, player.y + player.height / 2);
            if (player.shield) {
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, player.width, 0, Math.PI * 2);
                ctx.strokeStyle = "cyan";
                ctx.lineWidth = 3;
                ctx.stroke();
            }
        }

        // Draw Obstacles
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.font = "40px Arial"; // Increased font size
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(obstacle.emoji, obstacle.x + obstacle.width / 2, obstacle.y + obstacle.height / 2);
            });
        }

        // Draw Stars
        function drawStars() {
            stars.forEach(star => {
                ctx.font = "40px Arial"; // Increased font size
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(star.emoji, star.x + star.width / 2, star.y + star.height / 2);
            });
        }

        // Draw Shield
        function drawShield() {
            if (shieldObj.active) {
                ctx.beginPath();
                ctx.arc(shieldObj.x + shieldObj.width / 2, shieldObj.y + shieldObj.height, shieldObj.width / 2, Math.PI, 0, false);
                ctx.fillStyle = "rgba(0, 255, 255, 0.3)";
                ctx.fill();
                ctx.strokeStyle = "cyan";
                ctx.lineWidth = 3;
                ctx.stroke();
            }
        }

        // Move Obstacles
        function moveObstacles() {
            obstacles.forEach(obstacle => obstacle.y += obstacle.speed);
        }

        // Move Stars
        function moveStars() {
            stars.forEach(star => star.y += star.speed);
        }

        // Check Collisions
        function checkCollisions() {
            // Check Obstacles
            obstacles.forEach((obstacle, index) => {
                if (
                    player.x < obstacle.x + obstacle.width &&
                    player.x + player.width > obstacle.x &&
                    player.y < obstacle.y + obstacle.height &&
                    player.y + player.height > obstacle.y
                ) {
                    if (shieldObj.active) {
                        // Destroy the obstacle instead of game over
                        if (obstacle.type === 'bomb') {
                            // Bomb explodes
                            bombExplosionSound.play();
                            explodeBomb(obstacle);
                        }
                        obstacles.splice(index, 1);
                    } else {
                        collisionSound.play();
                        gameOver = true;
                        deathMessage.style.display = "block";
                    }
                }

                // Additional behavior for Bomb
                if (obstacle.type === 'bomb' && obstacle.y > canvas.height) {
                    bombExplosionSound.play();
                    explodeBomb(obstacle);
                    obstacles.splice(index, 1);
                }

                if (obstacle.y > canvas.height) {
                    obstacles.splice(index, 1);
                }
            });

            // Check Stars
            stars.forEach((star, index) => {
                if (
                    player.x < star.x + star.width &&
                    player.x + player.width > star.x &&
                    player.y < star.y + star.height &&
                    player.y + player.height > star.y
                ) {
                    collectSound.play();
                    if (star.type === 'star') {
                        score += 10;
                    } else if (star.type === 'money') {
                        money += 20; // More money for money bag
                    }
                    money += 5 * (1 + doubleMoneyUpgrade);
                    scoreDisplay.textContent = score;
                    moneyDisplay.textContent = money;
                    stars.splice(index, 1);
                    updateBuyButtons();
                }

                // Shield Protection (objects landing on shield slide off)
                if (shieldObj.active) {
                    if (
                        star.x < shieldObj.x + shieldObj.width &&
                        star.x + star.width > shieldObj.x &&
                        star.y < shieldObj.y + shieldObj.height &&
                        star.y + star.height > shieldObj.y
                    ) {
                        stars.splice(index, 1); // Remove star if within shield
                    }
                }

                if (star.y > canvas.height) {
                    stars.splice(index, 1);
                }
            });
        }

        // Explode Bomb Function
        function explodeBomb(bomb) {
            // Split all obstacles, stars, and bombs on screen
            obstacles.forEach(obstacle => {
                if (obstacle.type === 'fire' || obstacle.type === 'bomb') {
                    // Split obstacles into two smaller ones
                    const newSpeed = obstacle.speed;
                    const newX1 = obstacle.x - 10 > 0 ? obstacle.x - 10 : obstacle.x;
                    const newX2 = obstacle.x + 10 < canvas.width - obstacle.width ? obstacle.x + 10 : obstacle.x;
                    obstacles.push({ x: newX1, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                    obstacles.push({ x: newX2, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                }
            });

            stars.forEach((star, index) => {
                stars.splice(index, 1); // Remove all stars
            });
        }

        // Move Player Based on Input
        function movePlayer() {
            // Horizontal Movement
            if (keys["arrowleft"] || keys["a"]) {
                player.currentAcceleration = Math.max(player.currentAcceleration - player.acceleration, -player.speed);
            }
            if (keys["arrowright"] || keys["d"]) {
                player.currentAcceleration = Math.min(player.currentAcceleration + player.acceleration, player.speed);
            }

            // Apply Acceleration
            player.speed += player.currentAcceleration;
            player.speed = Math.max(player.baseSpeed, Math.min(player.speed, player.maxSpeed));

            // Update Position
            player.x += player.speed;

            // Clamp Position
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

            // Deceleration (Instant Stop)
            if (!keys["arrowleft"] && !keys["a"] && !keys["arrowright"] && !keys["d"]) {
                player.speed = player.baseSpeed;
                player.currentAcceleration = 0;
            }
        }

        // Activate Shield
        function activateShield() {
            if (shieldObj.canActivate) {
                shieldObj.active = true;
                shieldObj.duration = 5000; // 5 seconds in milliseconds
                shieldObj.cooldown = shieldUpgrade >= 50 ? 0 : 10000; // 10 seconds cooldown if not permanent
                shieldObj.canActivate = shieldUpgrade >= 50 ? true : false;
                shieldSound.play();
                updateShieldInfo();
            }
        }

        // Handle Shields
        function handleShields(deltaTime) {
            if (shieldObj.active) {
                shieldObj.duration -= deltaTime;
                if (shieldObj.duration <= 0) {
                    shieldObj.active = false;
                    if (shieldUpgrade < 50) {
                        shieldObj.cooldown = 10000; // Reset cooldown
                        shieldObj.canActivate = false;
                    }
                    updateShieldInfo();
                }
            }

            if (!shieldObj.canActivate && shieldUpgrade < 50) {
                shieldObj.cooldown -= deltaTime;
                if (shieldObj.cooldown <= 0) {
                    shieldObj.canActivate = true;
                    shieldObj.cooldown = 0;
                    updateShieldInfo();
                }
            }
        }

        // Update Shield Info Display
        function updateShieldInfo() {
            if (shieldObj.active) {
                if (shieldUpgrade >= 50) {
                    shieldStatus.textContent = "Active (Permanent)";
                    shieldTimer.textContent = "";
                } else {
                    shieldStatus.textContent = "Active";
                    shieldTimer.textContent = `Duration: ${(shieldObj.duration / 1000).toFixed(1)}s`;
                }
            } else {
                if (shieldUpgrade >= 50) {
                    shieldStatus.textContent = "Active (Permanent)";
                    shieldTimer.textContent = "";
                } else if (!shieldObj.canActivate) {
                    shieldStatus.textContent = "Cooldown";
                    shieldTimer.textContent = `Ready in ${(shieldObj.cooldown / 1000).toFixed(1)}s`;
                } else {
                    shieldStatus.textContent = "Ready";
                    shieldTimer.textContent = "";
                }
            }
        }

        // Increase Difficulty Based on Score
        function increaseDifficulty() {
            // Every 100 points, increase spawn rate and obstacle speed
            const difficultyLevel = Math.floor(score / 100);
            // Cap difficulty level to prevent excessive difficulty
            const cappedDifficulty = Math.min(difficultyLevel, 10);
            // Adjust spawn rate by modifying the spawn interval
            clearInterval(spawnInterval);
            const newSpawnRate = Math.max(500, 1000 - cappedDifficulty * 50); // Minimum 500ms spawn rate
            spawnInterval = setInterval(() => {
                if (!gamePaused && !gameOver) {
                    createObstacle();
                    createStar();
                }
            }, newSpawnRate);
        }

        // Game Loop
        function gameLoop(currentTime) {
            if (gamePaused || gameOver) return;

            const deltaTime = currentTime - lastFrameTime;
            if (deltaTime < frameDuration) {
                animationFrameId = requestAnimationFrame(gameLoop);
                return;
            }
            lastFrameTime = currentTime;

            movePlayer();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawShield();
            drawPlayer();
            drawObstacles();
            drawStars();
            drawHUD();

            moveObstacles();
            moveStars();
            checkCollisions();

            handleShields(deltaTime);

            // Increase difficulty based on score
            increaseDifficulty();

            if (gameOver) {
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('highScore', highScore);
                    highScoreDisplay.textContent = highScore;
                }
                menu.classList.add("active");
                bgMusic.pause();
                stopSpawning();
                saveProgress();
                return;
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Start Spawning Obstacles and Stars
        function startSpawning() {
            const initialSpawnRate = 1000; // 1 second
            spawnInterval = setInterval(() => {
                if (!gamePaused && !gameOver) {
                    createObstacle();
                    createStar();
                }
            }, initialSpawnRate);
        }

        // Stop Spawning
        function stopSpawning() {
            clearInterval(spawnInterval);
        }

        // Show Menu or Pause Menu
        function showMenu(isPause = false) {
            if (isPause) {
                menu.innerHTML = `
                    <h1>Paused</h1>
                    <button id="resumeButton">Resume Game</button>
                    <button id="openShopPause">Shop</button>
                `;
                const resumeButton = document.getElementById("resumeButton");
                const openShopPauseButton = document.getElementById("openShopPause");

                resumeButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    gamePaused = false;
                    gameLoop(performance.now());
                    startSpawning();
                    bgMusic.play();
                });

                openShopPauseButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    shop.classList.add("active");
                    updateBuyButtons();
                });
            } else {
                menu.innerHTML = `
                    <h1>Emoji Dodge Master</h1>
                    <p>Use Left/Right Arrow Keys or A/D to move horizontally.</p>
                    <p>Press W to dash left and S to dash right.</p>
                    <p>Avoid 🔥 and 💣, and collect ⭐ and 💰 to earn points!</p>
                    <button id="startButton">Start Game</button>
                    <button id="openShop">Shop</button>
                    <p id="deathMessage" style="display:none">Game Over! Try Again!</p>
                `;
                const newStartButton = document.getElementById("startButton");
                const newOpenShopButton = document.getElementById("openShop");

                newStartButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    resetGame();
                    gamePaused = false;
                    gameOver = false;
                    gameLoop(performance.now());
                    startSpawning();
                    bgMusic.play();
                });

                newOpenShopButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    shop.classList.add("active");
                    updateBuyButtons();
                });
            }
            menu.classList.add("active");
        }

        // Initial Menu Display
        showMenu(false);

        // Event Listeners for Opening and Closing Shop from Shop Interface
        closeShopButton.addEventListener("click", () => {
            shop.classList.remove("active");
            if (gameOver) {
                menu.classList.add("active");
            }
        });

        // Event Listeners for Opening Shop from Main Menu
        openShopButton.addEventListener("click", () => {
            menu.classList.remove("active");
            shop.classList.add("active");
            updateBuyButtons();
        });

        // Upgrade Purchase Handlers in Shop
        upgradeSpeedButton.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldButton.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyButton.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationButton.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedButton.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Upgrade Purchase Handlers in Main UI Panel
        upgradeSpeedMain.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldMain.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyMain.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationMain.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedMain.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Keyboard Controls for Movement and Dash
        document.addEventListener("keydown", e => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            if (key === "escape") {
                togglePause();
            }
            if (key === "space") {
                if (shieldObj.canActivate) {
                    activateShield();
                } else {
                    // Allow toggling shield if already active and at max upgrade
                    if (shieldObj.active && shieldUpgrade >= 50) {
                        shieldObj.active = false;
                        updateShieldInfo();
                    }
                }
            }
        });

        document.addEventListener("keyup", e => {
            const key = e.key.toLowerCase();
            keys[key] = false;
        });

        // Dash Functionality
        document.addEventListener("keydown", e => {
            const key = e.key.toLowerCase();
            if (key === "w" && player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
            if (key === "s" && player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Mobile Dash Buttons
        dashLeftButton.addEventListener("click", () => {
            if (player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        dashRightButton.addEventListener("click", () => {
            if (player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Toggle Pause Function
        function togglePause() {
            gamePaused = !gamePaused;
            if (gamePaused) {
                showMenu(true);
                stopSpawning();
                bgMusic.pause();
            } else {
                menu.classList.remove("active");
                gameLoop(performance.now());
                startSpawning();
                bgMusic.play();
            }
        }

        // Event Listener for Pause Button
        pauseButton.addEventListener("click", () => {
            togglePause();
        });

        // Event Listener for Help Button
        helpButton.addEventListener("click", () => {
            helpMenu.classList.add("active");
        });

        closeHelpButton.addEventListener("click", () => {
            helpMenu.classList.remove("active");
        });

        // Event Listener for Settings Button
        settingsButton.addEventListener("click", () => {
            settingsMenu.classList.add("active");
        });

        closeSettingsButton.addEventListener("click", () => {
            settingsMenu.classList.remove("active");
        });

        // Upgrade Purchase Handlers in Shop
        upgradeSpeedButton.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldButton.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyButton.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationButton.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedButton.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Upgrade Purchase Handlers in Main UI Panel
        upgradeSpeedMain.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldMain.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyMain.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationMain.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedMain.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Keyboard Controls for Movement and Dash
        document.addEventListener("keydown", e => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            if (key === "escape") {
                togglePause();
            }
            if (key === "space") {
                if (shieldObj.canActivate) {
                    activateShield();
                } else {
                    // Allow toggling shield if already active and at max upgrade
                    if (shieldObj.active && shieldUpgrade >= 50) {
                        shieldObj.active = false;
                        updateShieldInfo();
                    }
                }
            }
        });

        document.addEventListener("keyup", e => {
            const key = e.key.toLowerCase();
            keys[key] = false;
        });

        // Dash Functionality
        document.addEventListener("keydown", e => {
            const key = e.key.toLowerCase();
            if (key === "w" && player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
            if (key === "s" && player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Mobile Dash Buttons
        dashLeftButton.addEventListener("click", () => {
            if (player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        dashRightButton.addEventListener("click", () => {
            if (player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Toggle Pause Function
        function togglePause() {
            gamePaused = !gamePaused;
            if (gamePaused) {
                showMenu(true);
                stopSpawning();
                bgMusic.pause();
            } else {
                menu.classList.remove("active");
                gameLoop(performance.now());
                startSpawning();
                bgMusic.play();
            }
        }

        // Event Listener for Pause Button
        pauseButton.addEventListener("click", () => {
            togglePause();
        });

        // Event Listener for Help Button
        helpButton.addEventListener("click", () => {
            helpMenu.classList.add("active");
        });

        closeHelpButton.addEventListener("click", () => {
            helpMenu.classList.remove("active");
        });

        // Event Listener for Settings Button
        settingsButton.addEventListener("click", () => {
            settingsMenu.classList.add("active");
        });

        closeSettingsButton.addEventListener("click", () => {
            settingsMenu.classList.remove("active");
        });

        // Upgrade Purchase Handlers in Shop
        upgradeSpeedButton.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldButton.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyButton.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationButton.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedButton.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Upgrade Purchase Handlers in Main UI Panel
        upgradeSpeedMain.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldMain.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyMain.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationMain.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedMain.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Mobile Dash Buttons
        dashLeftButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        dashRightButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Settings Controls
        musicVolume.addEventListener("input", () => {
            bgMusic.volume = musicVolume.value;
        });

        sfxVolume.addEventListener("input", () => {
            collectSound.volume = sfxVolume.value;
            collisionSound.volume = sfxVolume.value;
            shieldSound.volume = sfxVolume.value;
            bombExplosionSound.volume = sfxVolume.value;
        });

        frameRateSelect.addEventListener("change", () => {
            targetFPS = parseInt(frameRateSelect.value);
            frameDuration = 1000 / targetFPS;
            saveProgress();
        });

        themeToggle.addEventListener("change", () => {
            const selectedTheme = themeToggle.value;
            if (selectedTheme === "light") {
                document.body.classList.add("light");
                document.body.classList.remove("dark");
            } else {
                document.body.classList.add("dark");
                document.body.classList.remove("light");
            }
            saveProgress();
        });

        // Save Game Immediately
        saveGameButton.addEventListener("click", () => {
            saveProgress();
            alert("Game Saved Successfully!");
        });

        // Reset Data with Confirmation
        resetDataButton.addEventListener("click", () => {
            if (confirm("Are you sure you want to reset all game data? This action cannot be undone.")) {
                localStorage.clear();
                location.reload();
            }
        });

        // Update Buy Buttons Based on Current Money
        function updateBuyButtons() {
            const speedPrice = 50 * (speedUpgrade + 1);
            const shieldPrice = 100 * (shieldUpgrade + 1);
            const doubleMoneyPrice = 150 * (doubleMoneyUpgrade + 1);
            const accelerationPrice = 200 * (accelerationUpgrade + 1);
            const maxSpeedPrice = 250 * (maxSpeedUpgrade + 1);

            // Shop Buttons
            upgradeSpeedButton.textContent = `Buy ($${speedPrice})`;
            buyShieldButton.textContent = `Buy ($${shieldPrice})`;
            buyDoubleMoneyButton.textContent = `Buy ($${doubleMoneyPrice})`;
            buyAccelerationButton.textContent = `Buy ($${accelerationPrice})`;
            buyMaxSpeedButton.textContent = `Buy ($${maxSpeedPrice})`;

            // Main UI Buttons
            upgradeSpeedMain.textContent = `Buy ($${speedPrice})`;
            buyShieldMain.textContent = `Buy ($${shieldPrice})`;
            buyDoubleMoneyMain.textContent = `Buy ($${doubleMoneyPrice})`;
            buyAccelerationMain.textContent = `Buy ($${accelerationPrice})`;
            buyMaxSpeedMain.textContent = `Buy ($${maxSpeedPrice})`;

            // Settings Buttons
            const settingsButtons = [upgradeSpeedButton, buyShieldButton, buyDoubleMoneyButton, buyAccelerationButton, buyMaxSpeedButton];
            const mainButtons = [upgradeSpeedMain, buyShieldMain, buyDoubleMoneyMain, buyAccelerationMain, buyMaxSpeedMain];
            const allButtons = [...settingsButtons, ...mainButtons];

            // Enable or Disable Buttons Based on Money and Apply Styles
            allButtons.forEach(button => {
                const priceMatch = button.textContent.match(/\$(\d+)/);
                if (priceMatch) {
                    const price = parseInt(priceMatch[1]);
                    if (money >= price) {
                        button.disabled = false;
                        button.classList.add("upgrade-available");
                        button.classList.remove("upgrade-unavailable");
                    } else {
                        button.disabled = true;
                        button.classList.remove("upgrade-available");
                        button.classList.add("upgrade-unavailable");
                    }
                }
            });
        }

        // Play Upgrade Sound
        function playUpgradeSound() {
            // Play a short sound effect when an upgrade is purchased
            // Ensure the collectSound is short and appropriate
            collectSound.currentTime = 0;
            collectSound.play();
        }

        // Keyboard Controls for Movement and Dash (Duplicate)
        // Removed duplicate event listeners to prevent conflicts

        // Collision Detection Precision
        function checkCollisions() {
            // Check Obstacles
            obstacles.forEach((obstacle, index) => {
                if (
                    player.x < obstacle.x + obstacle.width &&
                    player.x + player.width > obstacle.x &&
                    player.y < obstacle.y + obstacle.height &&
                    player.y + player.height > obstacle.y
                ) {
                    if (shieldObj.active) {
                        // Destroy the obstacle instead of game over
                        if (obstacle.type === 'bomb') {
                            // Bomb explodes
                            bombExplosionSound.play();
                            explodeBomb(obstacle);
                        }
                        obstacles.splice(index, 1);
                    } else {
                        collisionSound.play();
                        gameOver = true;
                        deathMessage.style.display = "block";
                    }
                }

                // Additional behavior for Bomb
                if (obstacle.type === 'bomb' && obstacle.y > canvas.height) {
                    bombExplosionSound.play();
                    explodeBomb(obstacle);
                    obstacles.splice(index, 1);
                }

                if (obstacle.y > canvas.height) {
                    obstacles.splice(index, 1);
                }
            });

            // Check Stars
            stars.forEach((star, index) => {
                if (
                    player.x < star.x + star.width &&
                    player.x + player.width > star.x &&
                    player.y < star.y + star.height &&
                    player.y + player.height > star.y
                ) {
                    collectSound.play();
                    if (star.type === 'star') {
                        score += 10;
                    } else if (star.type === 'money') {
                        money += 20; // More money for money bag
                    }
                    money += 5 * (1 + doubleMoneyUpgrade);
                    scoreDisplay.textContent = score;
                    moneyDisplay.textContent = money;
                    stars.splice(index, 1);
                    updateBuyButtons();
                }

                // Shield Protection (objects landing on shield slide off)
                if (shieldObj.active) {
                    if (
                        star.x < shieldObj.x + shieldObj.width &&
                        star.x + star.width > shieldObj.x &&
                        star.y < shieldObj.y + shieldObj.height &&
                        star.y + star.height > shieldObj.y
                    ) {
                        stars.splice(index, 1); // Remove star if within shield
                    }
                }

                if (star.y > canvas.height) {
                    stars.splice(index, 1);
                }
            });
        }

        // Explode Bomb Function
        function explodeBomb(bomb) {
            // Split all obstacles, stars, and bombs on screen
            obstacles.forEach(obstacle => {
                if (obstacle.type === 'fire' || obstacle.type === 'bomb') {
                    // Split obstacles into two smaller ones
                    const newSpeed = obstacle.speed;
                    const newX1 = obstacle.x - 10 > 0 ? obstacle.x - 10 : obstacle.x;
                    const newX2 = obstacle.x + 10 < canvas.width - obstacle.width ? obstacle.x + 10 : obstacle.x;
                    obstacles.push({ x: newX1, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                    obstacles.push({ x: newX2, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                }
            });

            stars.forEach((star, index) => {
                stars.splice(index, 1); // Remove all stars
            });
        }

        // Move Player Based on Input
        function movePlayer() {
            // Horizontal Movement
            if (keys["arrowleft"] || keys["a"]) {
                player.currentAcceleration = Math.max(player.currentAcceleration - player.acceleration, -player.speed);
            }
            if (keys["arrowright"] || keys["d"]) {
                player.currentAcceleration = Math.min(player.currentAcceleration + player.acceleration, player.speed);
            }

            // Apply Acceleration
            player.speed += player.currentAcceleration;
            player.speed = Math.max(player.baseSpeed, Math.min(player.speed, player.maxSpeed));

            // Update Position
            player.x += player.speed;

            // Clamp Position
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

            // Deceleration (Instant Stop)
            if (!keys["arrowleft"] && !keys["a"] && !keys["arrowright"] && !keys["d"]) {
                player.speed = player.baseSpeed;
                player.currentAcceleration = 0;
            }
        }

        // Activate Shield
        function activateShield() {
            if (shieldObj.canActivate) {
                shieldObj.active = true;
                shieldObj.duration = 5000; // 5 seconds in milliseconds
                shieldObj.cooldown = shieldUpgrade >= 50 ? 0 : 10000; // 10 seconds cooldown if not permanent
                shieldObj.canActivate = shieldUpgrade >= 50 ? true : false;
                shieldSound.play();
                updateShieldInfo();
            }
        }

        // Handle Shields
        function handleShields(deltaTime) {
            if (shieldObj.active) {
                shieldObj.duration -= deltaTime;
                if (shieldObj.duration <= 0) {
                    shieldObj.active = false;
                    if (shieldUpgrade < 50) {
                        shieldObj.cooldown = 10000; // Reset cooldown
                        shieldObj.canActivate = false;
                    }
                    updateShieldInfo();
                }
            }

            if (!shieldObj.canActivate && shieldUpgrade < 50) {
                shieldObj.cooldown -= deltaTime;
                if (shieldObj.cooldown <= 0) {
                    shieldObj.canActivate = true;
                    shieldObj.cooldown = 0;
                    updateShieldInfo();
                }
            }
        }

        // Update Shield Info Display
        function updateShieldInfo() {
            if (shieldObj.active) {
                if (shieldUpgrade >= 50) {
                    shieldStatus.textContent = "Active (Permanent)";
                    shieldTimer.textContent = "";
                } else {
                    shieldStatus.textContent = "Active";
                    shieldTimer.textContent = `Duration: ${(shieldObj.duration / 1000).toFixed(1)}s`;
                }
            } else {
                if (shieldUpgrade >= 50) {
                    shieldStatus.textContent = "Active (Permanent)";
                    shieldTimer.textContent = "";
                } else if (!shieldObj.canActivate) {
                    shieldStatus.textContent = "Cooldown";
                    shieldTimer.textContent = `Ready in ${(shieldObj.cooldown / 1000).toFixed(1)}s`;
                } else {
                    shieldStatus.textContent = "Ready";
                    shieldTimer.textContent = "";
                }
            }
        }

        // Increase Difficulty Based on Score
        function increaseDifficulty() {
            // Every 100 points, increase spawn rate and obstacle speed
            const difficultyLevel = Math.floor(score / 100);
            // Cap difficulty level to prevent excessive difficulty
            const cappedDifficulty = Math.min(difficultyLevel, 10);
            // Adjust spawn rate by modifying the spawn interval
            clearInterval(spawnInterval);
            const newSpawnRate = Math.max(500, 1000 - cappedDifficulty * 50); // Minimum 500ms spawn rate
            spawnInterval = setInterval(() => {
                if (!gamePaused && !gameOver) {
                    createObstacle();
                    createStar();
                }
            }, newSpawnRate);
        }

        // Game Loop
        function gameLoop(currentTime) {
            if (gamePaused || gameOver) return;

            const deltaTime = currentTime - lastFrameTime;
            if (deltaTime < frameDuration) {
                animationFrameId = requestAnimationFrame(gameLoop);
                return;
            }
            lastFrameTime = currentTime;

            movePlayer();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawShield();
            drawPlayer();
            drawObstacles();
            drawStars();
            drawHUD();

            moveObstacles();
            moveStars();
            checkCollisions();

            handleShields(deltaTime);

            // Increase difficulty based on score
            increaseDifficulty();

            if (gameOver) {
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('highScore', highScore);
                    highScoreDisplay.textContent = highScore;
                }
                menu.classList.add("active");
                bgMusic.pause();
                stopSpawning();
                saveProgress();
                return;
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Start Spawning Obstacles and Stars
        function startSpawning() {
            const initialSpawnRate = 1000; // 1 second
            spawnInterval = setInterval(() => {
                if (!gamePaused && !gameOver) {
                    createObstacle();
                    createStar();
                }
            }, initialSpawnRate);
        }

        // Stop Spawning
        function stopSpawning() {
            clearInterval(spawnInterval);
        }

        // Show Menu or Pause Menu
        function showMenu(isPause = false) {
            if (isPause) {
                menu.innerHTML = `
                    <h1>Paused</h1>
                    <button id="resumeButton">Resume Game</button>
                    <button id="openShopPause">Shop</button>
                `;
                const resumeButton = document.getElementById("resumeButton");
                const openShopPauseButton = document.getElementById("openShopPause");

                resumeButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    gamePaused = false;
                    gameLoop(performance.now());
                    startSpawning();
                    bgMusic.play();
                });

                openShopPauseButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    shop.classList.add("active");
                    updateBuyButtons();
                });
            } else {
                menu.innerHTML = `
                    <h1>Emoji Dodge Master</h1>
                    <p>Use Left/Right Arrow Keys or A/D to move horizontally.</p>
                    <p>Press W to dash left and S to dash right.</p>
                    <p>Avoid 🔥 and 💣, and collect ⭐ and 💰 to earn points!</p>
                    <button id="startButton">Start Game</button>
                    <button id="openShop">Shop</button>
                    <p id="deathMessage" style="display:none">Game Over! Try Again!</p>
                `;
                const newStartButton = document.getElementById("startButton");
                const newOpenShopButton = document.getElementById("openShop");

                newStartButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    resetGame();
                    gamePaused = false;
                    gameOver = false;
                    gameLoop(performance.now());
                    startSpawning();
                    bgMusic.play();
                });

                newOpenShopButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    shop.classList.add("active");
                    updateBuyButtons();
                });
            }
            menu.classList.add("active");
        }

        // Initial Menu Display
        showMenu(false);

        // Event Listeners for Opening and Closing Shop from Shop Interface
        closeShopButton.addEventListener("click", () => {
            shop.classList.remove("active");
            if (gameOver) {
                menu.classList.add("active");
            }
        });

        // Event Listeners for Opening Shop from Main Menu
        openShopButton.addEventListener("click", () => {
            menu.classList.remove("active");
            shop.classList.add("active");
            updateBuyButtons();
        });

        // Upgrade Purchase Handlers in Shop
        upgradeSpeedButton.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldButton.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyButton.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationButton.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedButton.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Upgrade Purchase Handlers in Main UI Panel
        upgradeSpeedMain.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldMain.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyMain.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationMain.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedMain.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Keyboard Controls for Movement and Dash
        document.addEventListener("keydown", e => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            if (key === "escape") {
                togglePause();
            }
            if (key === "space") {
                if (shieldObj.canActivate) {
                    activateShield();
                } else {
                    // Allow toggling shield if already active and at max upgrade
                    if (shieldObj.active && shieldUpgrade >= 50) {
                        shieldObj.active = false;
                        updateShieldInfo();
                    }
                }
            }
        });

        document.addEventListener("keyup", e => {
            const key = e.key.toLowerCase();
            keys[key] = false;
        });

        // Dash Functionality
        document.addEventListener("keydown", e => {
            const key = e.key.toLowerCase();
            if (key === "w" && player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
            if (key === "s" && player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Mobile Dash Buttons
        dashLeftButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        dashRightButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Toggle Pause Function
        function togglePause() {
            gamePaused = !gamePaused;
            if (gamePaused) {
                showMenu(true);
                stopSpawning();
                bgMusic.pause();
            } else {
                menu.classList.remove("active");
                gameLoop(performance.now());
                startSpawning();
                bgMusic.play();
            }
        }

        // Event Listener for Pause Button
        pauseButton.addEventListener("click", () => {
            togglePause();
        });

        // Event Listener for Help Button
        helpButton.addEventListener("click", () => {
            helpMenu.classList.add("active");
        });

        closeHelpButton.addEventListener("click", () => {
            helpMenu.classList.remove("active");
        });

        // Event Listener for Settings Button
        settingsButton.addEventListener("click", () => {
            settingsMenu.classList.add("active");
        });

        closeSettingsButton.addEventListener("click", () => {
            settingsMenu.classList.remove("active");
        });

        // Upgrade Purchase Handlers in Shop
        upgradeSpeedButton.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldButton.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyButton.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationButton.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedButton.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Upgrade Purchase Handlers in Main UI Panel
        upgradeSpeedMain.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldMain.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyMain.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationMain.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedMain.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Keyboard Controls for Movement and Dash (Duplicate Removed)

        // Mobile Dash Buttons
        dashLeftButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        dashRightButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Settings Controls
        musicVolume.addEventListener("input", () => {
            bgMusic.volume = musicVolume.value;
        });

        sfxVolume.addEventListener("input", () => {
            collectSound.volume = sfxVolume.value;
            collisionSound.volume = sfxVolume.value;
            shieldSound.volume = sfxVolume.value;
            bombExplosionSound.volume = sfxVolume.value;
        });

        frameRateSelect.addEventListener("change", () => {
            targetFPS = parseInt(frameRateSelect.value);
            frameDuration = 1000 / targetFPS;
            saveProgress();
        });

        themeToggle.addEventListener("change", () => {
            const selectedTheme = themeToggle.value;
            if (selectedTheme === "light") {
                document.body.classList.add("light");
                document.body.classList.remove("dark");
            } else {
                document.body.classList.add("dark");
                document.body.classList.remove("light");
            }
            saveProgress();
        });

        // Save Game Immediately
        saveGameButton.addEventListener("click", () => {
            saveProgress();
            alert("Game Saved Successfully!");
        });

        // Reset Data with Confirmation
        resetDataButton.addEventListener("click", () => {
            if (confirm("Are you sure you want to reset all game data? This action cannot be undone.")) {
                localStorage.clear();
                location.reload();
            }
        });

        // Update Buy Buttons Based on Current Money
        function updateBuyButtons() {
            const speedPrice = 50 * (speedUpgrade + 1);
            const shieldPrice = 100 * (shieldUpgrade + 1);
            const doubleMoneyPrice = 150 * (doubleMoneyUpgrade + 1);
            const accelerationPrice = 200 * (accelerationUpgrade + 1);
            const maxSpeedPrice = 250 * (maxSpeedUpgrade + 1);

            // Shop Buttons
            upgradeSpeedButton.textContent = `Buy ($${speedPrice})`;
            buyShieldButton.textContent = `Buy ($${shieldPrice})`;
            buyDoubleMoneyButton.textContent = `Buy ($${doubleMoneyPrice})`;
            buyAccelerationButton.textContent = `Buy ($${accelerationPrice})`;
            buyMaxSpeedButton.textContent = `Buy ($${maxSpeedPrice})`;

            // Main UI Buttons
            upgradeSpeedMain.textContent = `Buy ($${speedPrice})`;
            buyShieldMain.textContent = `Buy ($${shieldPrice})`;
            buyDoubleMoneyMain.textContent = `Buy ($${doubleMoneyPrice})`;
            buyAccelerationMain.textContent = `Buy ($${accelerationPrice})`;
            buyMaxSpeedMain.textContent = `Buy ($${maxSpeedPrice})`;

            // Settings Buttons
            const settingsButtons = [upgradeSpeedButton, buyShieldButton, buyDoubleMoneyButton, buyAccelerationButton, buyMaxSpeedButton];
            const mainButtons = [upgradeSpeedMain, buyShieldMain, buyDoubleMoneyMain, buyAccelerationMain, buyMaxSpeedMain];
            const allButtons = [...settingsButtons, ...mainButtons];

            // Enable or Disable Buttons Based on Money and Apply Styles
            allButtons.forEach(button => {
                const priceMatch = button.textContent.match(/\$(\d+)/);
                if (priceMatch) {
                    const price = parseInt(priceMatch[1]);
                    if (money >= price) {
                        button.disabled = false;
                        button.classList.add("upgrade-available");
                        button.classList.remove("upgrade-unavailable");
                    } else {
                        button.disabled = true;
                        button.classList.remove("upgrade-available");
                        button.classList.add("upgrade-unavailable");
                    }
                }
            });
        }

        // Play Upgrade Sound
        function playUpgradeSound() {
            // Play a short sound effect when an upgrade is purchased
            // Ensure the collectSound is short and appropriate
            collectSound.currentTime = 0;
            collectSound.play();
        }

        // Handle Collision Detection Precision
        function checkCollisions() {
            // Check Obstacles
            obstacles.forEach((obstacle, index) => {
                if (
                    player.x < obstacle.x + obstacle.width &&
                    player.x + player.width > obstacle.x &&
                    player.y < obstacle.y + obstacle.height &&
                    player.y + player.height > obstacle.y
                ) {
                    if (shieldObj.active) {
                        // Destroy the obstacle instead of game over
                        if (obstacle.type === 'bomb') {
                            // Bomb explodes
                            bombExplosionSound.play();
                            explodeBomb(obstacle);
                        }
                        obstacles.splice(index, 1);
                    } else {
                        collisionSound.play();
                        gameOver = true;
                        deathMessage.style.display = "block";
                    }
                }

                // Additional behavior for Bomb
                if (obstacle.type === 'bomb' && obstacle.y > canvas.height) {
                    bombExplosionSound.play();
                    explodeBomb(obstacle);
                    obstacles.splice(index, 1);
                }

                if (obstacle.y > canvas.height) {
                    obstacles.splice(index, 1);
                }
            });

            // Check Stars
            stars.forEach((star, index) => {
                if (
                    player.x < star.x + star.width &&
                    player.x + player.width > star.x &&
                    player.y < star.y + star.height &&
                    player.y + player.height > star.y
                ) {
                    collectSound.play();
                    if (star.type === 'star') {
                        score += 10;
                    } else if (star.type === 'money') {
                        money += 20; // More money for money bag
                    }
                    money += 5 * (1 + doubleMoneyUpgrade);
                    scoreDisplay.textContent = score;
                    moneyDisplay.textContent = money;
                    stars.splice(index, 1);
                    updateBuyButtons();
                }

                // Shield Protection (objects landing on shield slide off)
                if (shieldObj.active) {
                    if (
                        star.x < shieldObj.x + shieldObj.width &&
                        star.x + star.width > shieldObj.x &&
                        star.y < shieldObj.y + shieldObj.height &&
                        star.y + star.height > shieldObj.y
                    ) {
                        stars.splice(index, 1); // Remove star if within shield
                    }
                }

                if (star.y > canvas.height) {
                    stars.splice(index, 1);
                }
            });
        }

        // Explode Bomb Function
        function explodeBomb(bomb) {
            // Split all obstacles, stars, and bombs on screen
            obstacles.forEach(obstacle => {
                if (obstacle.type === 'fire' || obstacle.type === 'bomb') {
                    // Split obstacles into two smaller ones
                    const newSpeed = obstacle.speed;
                    const newX1 = obstacle.x - 10 > 0 ? obstacle.x - 10 : obstacle.x;
                    const newX2 = obstacle.x + 10 < canvas.width - obstacle.width ? obstacle.x + 10 : obstacle.x;
                    obstacles.push({ x: newX1, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                    obstacles.push({ x: newX2, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                }
            });

            stars.forEach((star, index) => {
                stars.splice(index, 1); // Remove all stars
            });
        }

        // Move Player Based on Input
        function movePlayer() {
            // Horizontal Movement
            if (keys["arrowleft"] || keys["a"]) {
                player.currentAcceleration = Math.max(player.currentAcceleration - player.acceleration, -player.speed);
            }
            if (keys["arrowright"] || keys["d"]) {
                player.currentAcceleration = Math.min(player.currentAcceleration + player.acceleration, player.speed);
            }

            // Apply Acceleration
            player.speed += player.currentAcceleration;
            player.speed = Math.max(player.baseSpeed, Math.min(player.speed, player.maxSpeed));

            // Update Position
            player.x += player.speed;

            // Clamp Position
            player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

            // Deceleration (Instant Stop)
            if (!keys["arrowleft"] && !keys["a"] && !keys["arrowright"] && !keys["d"]) {
                player.speed = player.baseSpeed;
                player.currentAcceleration = 0;
            }
        }

        // Activate Shield
        function activateShield() {
            if (shieldObj.canActivate) {
                shieldObj.active = true;
                shieldObj.duration = 5000; // 5 seconds in milliseconds
                shieldObj.cooldown = shieldUpgrade >= 50 ? 0 : 10000; // 10 seconds cooldown if not permanent
                shieldObj.canActivate = shieldUpgrade >= 50 ? true : false;
                shieldSound.play();
                updateShieldInfo();
            }
        }

        // Handle Shields
        function handleShields(deltaTime) {
            if (shieldObj.active) {
                shieldObj.duration -= deltaTime;
                if (shieldObj.duration <= 0) {
                    shieldObj.active = false;
                    if (shieldUpgrade < 50) {
                        shieldObj.cooldown = 10000; // Reset cooldown
                        shieldObj.canActivate = false;
                    }
                    updateShieldInfo();
                }
            }

            if (!shieldObj.canActivate && shieldUpgrade < 50) {
                shieldObj.cooldown -= deltaTime;
                if (shieldObj.cooldown <= 0) {
                    shieldObj.canActivate = true;
                    shieldObj.cooldown = 0;
                    updateShieldInfo();
                }
            }
        }

        // Update Shield Info Display
        function updateShieldInfo() {
            if (shieldObj.active) {
                if (shieldUpgrade >= 50) {
                    shieldStatus.textContent = "Active (Permanent)";
                    shieldTimer.textContent = "";
                } else {
                    shieldStatus.textContent = "Active";
                    shieldTimer.textContent = `Duration: ${(shieldObj.duration / 1000).toFixed(1)}s`;
                }
            } else {
                if (shieldUpgrade >= 50) {
                    shieldStatus.textContent = "Active (Permanent)";
                    shieldTimer.textContent = "";
                } else if (!shieldObj.canActivate) {
                    shieldStatus.textContent = "Cooldown";
                    shieldTimer.textContent = `Ready in ${(shieldObj.cooldown / 1000).toFixed(1)}s`;
                } else {
                    shieldStatus.textContent = "Ready";
                    shieldTimer.textContent = "";
                }
            }
        }

        // Increase Difficulty Based on Score
        function increaseDifficulty() {
            // Every 100 points, increase spawn rate and obstacle speed
            const difficultyLevel = Math.floor(score / 100);
            // Cap difficulty level to prevent excessive difficulty
            const cappedDifficulty = Math.min(difficultyLevel, 10);
            // Adjust spawn rate by modifying the spawn interval
            clearInterval(spawnInterval);
            const newSpawnRate = Math.max(500, 1000 - cappedDifficulty * 50); // Minimum 500ms spawn rate
            spawnInterval = setInterval(() => {
                if (!gamePaused && !gameOver) {
                    createObstacle();
                    createStar();
                }
            }, newSpawnRate);
        }

        // Game Loop
        function gameLoop(currentTime) {
            if (gamePaused || gameOver) return;

            const deltaTime = currentTime - lastFrameTime;
            if (deltaTime < frameDuration) {
                animationFrameId = requestAnimationFrame(gameLoop);
                return;
            }
            lastFrameTime = currentTime;

            movePlayer();

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawShield();
            drawPlayer();
            drawObstacles();
            drawStars();
            drawHUD();

            moveObstacles();
            moveStars();
            checkCollisions();

            handleShields(deltaTime);

            // Increase difficulty based on score
            increaseDifficulty();

            if (gameOver) {
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('highScore', highScore);
                    highScoreDisplay.textContent = highScore;
                }
                menu.classList.add("active");
                bgMusic.pause();
                stopSpawning();
                saveProgress();
                return;
            }

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // Start Spawning Obstacles and Stars
        function startSpawning() {
            const initialSpawnRate = 1000; // 1 second
            spawnInterval = setInterval(() => {
                if (!gamePaused && !gameOver) {
                    createObstacle();
                    createStar();
                }
            }, initialSpawnRate);
        }

        // Stop Spawning
        function stopSpawning() {
            clearInterval(spawnInterval);
        }

        // Show Menu or Pause Menu
        function showMenu(isPause = false) {
            if (isPause) {
                menu.innerHTML = `
                    <h1>Paused</h1>
                    <button id="resumeButton">Resume Game</button>
                    <button id="openShopPause">Shop</button>
                `;
                const resumeButton = document.getElementById("resumeButton");
                const openShopPauseButton = document.getElementById("openShopPause");

                resumeButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    gamePaused = false;
                    gameLoop(performance.now());
                    startSpawning();
                    bgMusic.play();
                });

                openShopPauseButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    shop.classList.add("active");
                    updateBuyButtons();
                });
            } else {
                menu.innerHTML = `
                    <h1>Emoji Dodge Master</h1>
                    <p>Use Left/Right Arrow Keys or A/D to move horizontally.</p>
                    <p>Press W to dash left and S to dash right.</p>
                    <p>Avoid 🔥 and 💣, and collect ⭐ and 💰 to earn points!</p>
                    <button id="startButton">Start Game</button>
                    <button id="openShop">Shop</button>
                    <p id="deathMessage" style="display:none">Game Over! Try Again!</p>
                `;
                const newStartButton = document.getElementById("startButton");
                const newOpenShopButton = document.getElementById("openShop");

                newStartButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    resetGame();
                    gamePaused = false;
                    gameOver = false;
                    gameLoop(performance.now());
                    startSpawning();
                    bgMusic.play();
                });

                newOpenShopButton.addEventListener("click", () => {
                    menu.classList.remove("active");
                    shop.classList.add("active");
                    updateBuyButtons();
                });
            }
            menu.classList.add("active");
        }

        // Initial Menu Display
        showMenu(false);

        // Event Listeners for Opening and Closing Shop from Shop Interface
        closeShopButton.addEventListener("click", () => {
            shop.classList.remove("active");
            if (gameOver) {
                menu.classList.add("active");
            }
        });

        // Event Listeners for Opening Shop from Main Menu
        openShopButton.addEventListener("click", () => {
            menu.classList.remove("active");
            shop.classList.add("active");
            updateBuyButtons();
        });

        // Upgrade Purchase Handlers in Shop
        upgradeSpeedButton.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldButton.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyButton.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationButton.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedButton.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Upgrade Purchase Handlers in Main UI Panel
        upgradeSpeedMain.addEventListener("click", () => {
            const price = 50 * (speedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                speedUpgrade += 1;
                speedLevelDisplay.textContent = speedUpgrade;
                player.baseSpeed += 0.5;
                player.maxSpeed += 0.5;
                player.speed = player.baseSpeed;
                localStorage.setItem('speedUpgrade', speedUpgrade);
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                shieldObj.maxCooldown = Math.max(5000, shieldObj.maxCooldown - 500); // Example adjustment
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyShieldMain.addEventListener("click", () => {
            const price = 100 * (shieldUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                shieldUpgrade += 1;
                shieldLevelDisplay.textContent = shieldUpgrade;
                localStorage.setItem('shieldUpgrade', shieldUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyDoubleMoneyMain.addEventListener("click", () => {
            const price = 150 * (doubleMoneyUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                doubleMoneyUpgrade += 1;
                doubleMoneyLevelDisplay.textContent = doubleMoneyUpgrade;
                localStorage.setItem('doubleMoneyUpgrade', doubleMoneyUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyAccelerationMain.addEventListener("click", () => {
            const price = 200 * (accelerationUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                accelerationUpgrade += 1;
                accelerationLevelDisplay.textContent = accelerationUpgrade;
                player.acceleration += 0.05;
                localStorage.setItem('accelerationUpgrade', accelerationUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        buyMaxSpeedMain.addEventListener("click", () => {
            const price = 250 * (maxSpeedUpgrade + 1); // Scalable pricing
            if (money >= price) {
                money -= price;
                moneyDisplay.textContent = money;
                maxSpeedUpgrade += 1;
                maxSpeedLevelDisplay.textContent = maxSpeedUpgrade;
                player.maxSpeed += 1;
                localStorage.setItem('maxSpeedUpgrade', maxSpeedUpgrade);
                saveProgress();
                updateBuyButtons();
                playUpgradeSound();
            }
        });

        // Keyboard Controls for Movement and Dash (Duplicate Removed)

        // Mobile Dash Buttons
        dashLeftButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.max(0, player.x - player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        dashRightButton.addEventListener("touchstart", () => {
            if (player.canDash) {
                player.x = Math.min(canvas.width - player.width, player.x + player.dashSpeed);
                player.canDash = false;
                setTimeout(() => { player.canDash = true; }, 1000); // 1 second cooldown
            }
        });

        // Settings Controls
        musicVolume.addEventListener("input", () => {
            bgMusic.volume = musicVolume.value;
        });

        sfxVolume.addEventListener("input", () => {
            collectSound.volume = sfxVolume.value;
            collisionSound.volume = sfxVolume.value;
            shieldSound.volume = sfxVolume.value;
            bombExplosionSound.volume = sfxVolume.value;
        });

        frameRateSelect.addEventListener("change", () => {
            targetFPS = parseInt(frameRateSelect.value);
            frameDuration = 1000 / targetFPS;
            saveProgress();
        });

        themeToggle.addEventListener("change", () => {
            const selectedTheme = themeToggle.value;
            if (selectedTheme === "light") {
                document.body.classList.add("light");
                document.body.classList.remove("dark");
            } else {
                document.body.classList.add("dark");
                document.body.classList.remove("light");
            }
            saveProgress();
        });

        // Save Game Immediately
        saveGameButton.addEventListener("click", () => {
            saveProgress();
            alert("Game Saved Successfully!");
        });

        // Reset Data with Confirmation
        resetDataButton.addEventListener("click", () => {
            if (confirm("Are you sure you want to reset all game data? This action cannot be undone.")) {
                localStorage.clear();
                location.reload();
            }
        });

        // Update Buy Buttons Based on Current Money
        function updateBuyButtons() {
            const speedPrice = 50 * (speedUpgrade + 1);
            const shieldPrice = 100 * (shieldUpgrade + 1);
            const doubleMoneyPrice = 150 * (doubleMoneyUpgrade + 1);
            const accelerationPrice = 200 * (accelerationUpgrade + 1);
            const maxSpeedPrice = 250 * (maxSpeedUpgrade + 1);

            // Shop Buttons
            upgradeSpeedButton.textContent = `Buy ($${speedPrice})`;
            buyShieldButton.textContent = `Buy ($${shieldPrice})`;
            buyDoubleMoneyButton.textContent = `Buy ($${doubleMoneyPrice})`;
            buyAccelerationButton.textContent = `Buy ($${accelerationPrice})`;
            buyMaxSpeedButton.textContent = `Buy ($${maxSpeedPrice})`;

            // Main UI Buttons
            upgradeSpeedMain.textContent = `Buy ($${speedPrice})`;
            buyShieldMain.textContent = `Buy ($${shieldPrice})`;
            buyDoubleMoneyMain.textContent = `Buy ($${doubleMoneyPrice})`;
            buyAccelerationMain.textContent = `Buy ($${accelerationPrice})`;
            buyMaxSpeedMain.textContent = `Buy ($${maxSpeedPrice})`;

            // Settings Buttons
            const settingsButtons = [upgradeSpeedButton, buyShieldButton, buyDoubleMoneyButton, buyAccelerationButton, buyMaxSpeedButton];
            const mainButtons = [upgradeSpeedMain, buyShieldMain, buyDoubleMoneyMain, buyAccelerationMain, buyMaxSpeedMain];
            const allButtons = [...settingsButtons, ...mainButtons];

            // Enable or Disable Buttons Based on Money and Apply Styles
            allButtons.forEach(button => {
                const priceMatch = button.textContent.match(/\$(\d+)/);
                if (priceMatch) {
                    const price = parseInt(priceMatch[1]);
                    if (money >= price) {
                        button.disabled = false;
                        button.classList.add("upgrade-available");
                        button.classList.remove("upgrade-unavailable");
                    } else {
                        button.disabled = true;
                        button.classList.remove("upgrade-available");
                        button.classList.add("upgrade-unavailable");
                    }
                }
            });
        }

        // Play Upgrade Sound
        function playUpgradeSound() {
            // Play a short sound effect when an upgrade is purchased
            // Ensure the collectSound is short and appropriate
            collectSound.currentTime = 0;
            collectSound.play();
        }

        // Handle Collision Detection Precision
        function checkCollisions() {
            // Check Obstacles
            obstacles.forEach((obstacle, index) => {
                if (
                    player.x < obstacle.x + obstacle.width &&
                    player.x + player.width > obstacle.x &&
                    player.y < obstacle.y + obstacle.height &&
                    player.y + player.height > obstacle.y
                ) {
                    if (shieldObj.active) {
                        // Destroy the obstacle instead of game over
                        if (obstacle.type === 'bomb') {
                            // Bomb explodes
                            bombExplosionSound.play();
                            explodeBomb(obstacle);
                        }
                        obstacles.splice(index, 1);
                    } else {
                        collisionSound.play();
                        gameOver = true;
                        deathMessage.style.display = "block";
                    }
                }

                // Additional behavior for Bomb
                if (obstacle.type === 'bomb' && obstacle.y > canvas.height) {
                    bombExplosionSound.play();
                    explodeBomb(obstacle);
                    obstacles.splice(index, 1);
                }

                if (obstacle.y > canvas.height) {
                    obstacles.splice(index, 1);
                }
            });

            // Check Stars
            stars.forEach((star, index) => {
                if (
                    player.x < star.x + star.width &&
                    player.x + player.width > star.x &&
                    player.y < star.y + star.height &&
                    player.y + player.height > star.y
                ) {
                    collectSound.play();
                    if (star.type === 'star') {
                        score += 10;
                    } else if (star.type === 'money') {
                        money += 20; // More money for money bag
                    }
                    money += 5 * (1 + doubleMoneyUpgrade);
                    scoreDisplay.textContent = score;
                    moneyDisplay.textContent = money;
                    stars.splice(index, 1);
                    updateBuyButtons();
                }

                // Shield Protection (objects landing on shield slide off)
                if (shieldObj.active) {
                    if (
                        star.x < shieldObj.x + shieldObj.width &&
                        star.x + star.width > shieldObj.x &&
                        star.y < shieldObj.y + shieldObj.height &&
                        star.y + star.height > shieldObj.y
                    ) {
                        stars.splice(index, 1); // Remove star if within shield
                    }
                }

                if (star.y > canvas.height) {
                    stars.splice(index, 1);
                }
            });
        }

        // Explode Bomb Function
        function explodeBomb(bomb) {
            // Split all obstacles, stars, and bombs on screen
            obstacles.forEach(obstacle => {
                if (obstacle.type === 'fire' || obstacle.type === 'bomb') {
                    // Split obstacles into two smaller ones
                    const newSpeed = obstacle.speed;
                    const newX1 = obstacle.x - 10 > 0 ? obstacle.x - 10 : obstacle.x;
                    const newX2 = obstacle.x + 10 < canvas.width - obstacle.width ? obstacle.x + 10 : obstacle.x;
                    obstacles.push({ x: newX1, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                    obstacles.push({ x: newX2, y: -40, width: 40, height: 40, emoji: '🔥', speed: newSpeed, type: 'fire' });
                }
            });

            stars.forEach((star, index) => {
                stars.splice(index, 1); // Remove all stars
            });
        }

        // Draw HUD (Shield Info)
        function drawHUD() {
            // Shield Info is already handled by the shieldInfo div
            // This function can be expanded for additional HUD elements if needed
        }

        // Handle Tab Switching and Window Focus
        window.addEventListener('blur', () => {
            if (!gameOver) {
                togglePause();
            }
        });

        // Prevent accidental tab closure with confirmation
        window.addEventListener('beforeunload', function (e) {
            if (!gameOver && !gamePaused) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize Background Music Settings
        bgMusic.volume = 0.3; // Adjust volume as needed
        collectSound.volume = 0.5;
        collisionSound.volume = 0.5;
        shieldSound.volume = 0.5;
        bombExplosionSound.volume = 0.5;

        // Start Background Music When Game Starts
        startButton?.addEventListener("click", () => {
            bgMusic.play();
        });

        // Responsive Canvas
        function resizeCanvas() {
            const aspectRatio = canvas.width / canvas.height;
            let newWidth = window.innerWidth * 0.9;
            let newHeight = newWidth / aspectRatio;
            if (newHeight > window.innerHeight * 0.8) { // Adjusted for footer and shield info
                newHeight = window.innerHeight * 0.8;
                newWidth = newHeight * aspectRatio;
            }
            canvas.style.width = `${newWidth}px`;
            canvas.style.height = `${newHeight}px`;
            // Update shield position based on new canvas size
            shieldObj.x = 20;
            shieldObj.y = canvas.height - 120;
            shieldInfo.style.left = '10px';
            shieldInfo.style.bottom = '10px';
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Touch Controls for Mobile Devices
        let touchStartX = null;

        canvas.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            touchStartX = touch.clientX;
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!touchStartX) return;
            const touch = e.touches[0];
            const deltaX = touch.clientX - touchStartX;
            if (deltaX > 20) {
                keys["arrowright"] = true;
                keys["arrowleft"] = false;
            } else if (deltaX < -20) {
                keys["arrowleft"] = true;
                keys["arrowright"] = false;
            }
        });

        canvas.addEventListener('touchend', () => {
            keys["arrowleft"] = false;
            keys["arrowright"] = false;
            touchStartX = null;
        });

        // Update Buy Buttons on Money Change
        function updateMoney(amount) {
            money += amount;
            moneyDisplay.textContent = money;
            updateBuyButtons();
            saveProgress();
        }

        // Handle Upgrade Effects
        function handleUpgradeEffects() {
            // Currently, speed and max speed are handled during purchase
            // Double Money is handled during collection
            // Shield is handled during activation
            // Add more effects as needed
        }

        // Initialize Game
        resetGame();

        // Start Spawning Obstacles and Stars when Game Starts
        function startGame() {
            resetGame();
            menu.classList.remove("active");
            gamePaused = false;
            gameOver = false;
            gameLoop(performance.now());
            startSpawning();
            bgMusic.play();
        }

        // Event Listener for Start Game Button
        startButton.addEventListener("click", () => {
            startGame();
        });

        // Ensure shop buttons reflect affordability on opening
        shop.addEventListener("transitionend", () => {
            if (shop.classList.contains("active")) {
                updateBuyButtons();
            }
        });

        // Listen for any change in money to update UI
        // Removed MutationObserver as it's unnecessary

        // Initial Update of Buy Buttons
        updateBuyButtons();

        // Visual Indicators for Shield Cooldown and Duration
        function drawHUD() {
            updateShieldInfo();
        }

        // Handle Tab Switching and Window Focus
        window.addEventListener('blur', () => {
            if (!gameOver) {
                togglePause();
            }
        });

        // Prevent accidental tab closure with confirmation
        window.addEventListener('beforeunload', function (e) {
            if (!gameOver && !gamePaused) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize Background Music Settings
        bgMusic.volume = 0.3; // Adjust volume as needed
        collectSound.volume = 0.5;
        collisionSound.volume = 0.5;
        shieldSound.volume = 0.5;
        bombExplosionSound.volume = 0.5;

        // Start Background Music When Game Starts
        startButton?.addEventListener("click", () => {
            bgMusic.play();
        });

        // Handle Game Launch with Saved Theme
        window.addEventListener('load', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add("light");
                themeToggle.value = 'light';
            } else {
                document.body.classList.add("dark");
                themeToggle.value = 'dark';
            }
        });

    </script>
</body>
</html>
